SHELL := bash
.ONESHELL:
.SHELLFLAGS := -eu -o pipefail -c
.DELETE_ON_ERROR:
MAKEFLAGS += --warn-undefined-variables
MAKEFLAGS += --no-builtin-rules

### Install dependencies

.PHONY: install-dev
install-dev: ## Install development dependencies
	npm ci

# Note: There is no install prod as we are using nginx to serve our application in production environment

.PHONY: upgrade
upgrade: ## Upgrade all dependencies
	npm update --loglevel verbose

### Build and run application

.PHONY: run-dev
run-dev: ## Run dev mode
	npm run dev

.PHONY: run-dev-docker
run-dev-docker: install-dev run-dev ## Install then run dev mode

.PHONY: build-prod
build-prod: ## Build prod
	$(MAKE) install-dev
	npm run build-only

.PHONY: build-preview
build-preview: ## Run preview with vite server (to launch after building app to check the build)
	npm run preview

# Note: There is no run prod as we are using nginx to serve our application in production environment

### Format and checks

.PHONY: lint-check
lint-check: ## Check lint code.
	npm run type-check
	npm run lint-check

.PHONY: lint-fix
lint-fix: ## Lint code and fix.
	npm run type-check
	npm run lint-fix

.PHONY: lint
lint: lint-fix ## Lint code and fix.

.PHONY: format-fix
format-fix: ## Fix format.
	npm run format-fix

.PHONY: format
format: format-fix ## Fix format.

.PHONY: format-check
format-check: ## Format code check.
	npm run format-check

.PHONY: audit-check
audit-check: ## Audit dependencies.
	npm audit

.PHONY: openapi-update
openapi-update: ## Update types from openapi file
	curl http://eukleia.test/api/v1/openapi.json --output data/openapi.json
	npx openapi-typescript data/openapi.json -o ./src/api/models/api.d.ts

.PHONY: openapi-check
openapi-check: ## Check if types generated based on openapi are up to date with last version of openapi
	npx openapi-typescript data/openapi.json -o ./src/api/models/api.d.ts --check || (echo "Please run command: make update-api-types" && exit 1)

.PHONY: hadolint-check
hadolint-check: ## Run checks on Dockerfile
	docker run --rm -i remote-docker-hub.artifactory.example.com/hadolint/hadolint < docker/Dockerfile

.PHONY: checks
checks: ## Run checks on code (lint, format, api types)
	$(MAKE) lint-check
	$(MAKE) format-check
	$(MAKE) openapi-check
	# $(MAKE) audit-check

### Tests

.PHONY: tests
tests: ## Run frontend tests
	npm run tests

.PHONY: trivy-npm
trivy-npm:
	docker run -v ./package-lock.json:/package-lock.json --pull always local-docker-abc.artifactory.example.com/trivy:latest fs --config /table.yaml --include-dev-deps --ignore-unfixed /package-lock.json


### Docker

.PHONY: docker-run-dev
docker-run-dev: ## Run docker image of dev environement (serves to localhost:8080)
	docker build -t frontend-tmp --target dev -f docker/Dockerfile .
	docker run --rm -p 8080:8080 frontend-tmp

.PHONY: docker-run-ci
docker-run-ci: ## Run docker image of ci environement (run bash)
	docker build -t frontend-tmp --target ci -f docker/Dockerfile .
	docker run -ti --rm frontend-tmp /bin/bash

.PHONY: docker-run-prod
docker-run-prod: ## Run docker image of prod environement (serves to localhost:8080)
	docker build -t frontend-tmp --target prod -f docker/Dockerfile .
	docker run --rm -p 8080:8080 -e NGINX_SERVER_NAME=localhost frontend-tmp

### Misc

.PHONY: clean
clean: ## Clean dependencies.
	rm -rf node_modules
	rm -rf test-reports
	rm -rf dist

### Help

.PHONY: help
help: ## Show this help.
	@echo "Usage:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

.DEFAULT_GOAL := help
